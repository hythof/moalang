# Draft specification

This is subset specification for first generation runtime



## 1. Value

Literals
```
true # bool
1    # int 64bit signed integer
"hi" # string utf8
```

Container
```
[1 2]
array{int}
array{int}(1 2)
```



## 2. Expression

Binary operation
```
1 + 2 * 3
```

Branch
```
a > b
| "true"
| "false"

n
| 0 = "zero"
| 1 = "one"
| _ = "many"

statement
| v -> `succeed $v`
| e -> `failed $e`
```

Effect
```
value <- effect(1)
func
```

Helper
```
tokenize src = top:
  pos 0
  tokens []
  top =
    t <- read_num.or(read_op).guard("tokenize" src pos)
    tokens.append(t)
    top.else(tokens)
  read_num = many1(any("0123456789".array)).map(.int)
  read_op = many1(any("+-*/".array))
  many1 f =
    c <- f
    cs <- f.many
    cs.prepend(c)
  any ary = ary.first(satisfy)
  satisfy f = skip:
    c = src.char(pos)
    skip = c.in(" " "\n")
    | pos += 1; skip
    | try
    try = f(c)
    | pos += 1; c
    | nil
```



## 3. Definition

Function
```
pi = 3.14

add x y = x + y

echo =
  line <- io.readline
  io.print(line)
```

Structure
```
vector2:
  x int
  y int

dict k v:
  kvs [k v]
```

Enumeration
```
abc| a b c
cupon|
  zero
  prize:
    name string
    price int
```



## 4. Syntax
```
root: def (br def)*
def:
| ref+ ":" (indent attr)+
| ref+ "|" (indent tag)+
| func
func: id arg* "=" body
attr: id type
tag :
| attr
| id ":" (indent attr)+
body:
| (indent exp)+
| exp (helper | branch)?
helper: ":" (indent attr)* (indent func)+
branch: (indent "|" unit ("->" | "=") exp)+
exp:
| unit op2 exp
| ref op2u exp
| unit
unit:
| literal
| id ("." id ("(" exp* ")")?)*
| "(" exp ")"
| "[" unit* "]"
literal:
| [0-9]+ ("." [0-9]+)?
| '"' [^"]* '"'
| "true"
| "false"
| "nil"
| "[" literal+ "]"
id  : [a-z0-9_]+
ref : id (. id)*
type: ref ("(" ref+ ")")?
op2 : [+ - * / << >> > >= < <=  == != || &&]
op2u: [= := += /= *= /=]
indent: "\n  "
br: "\n  "
```

Symbols
```
--- single ----------------------------
_            # ignore
+ - / *      # arithmetic
> >= < <= == # bool operators
:=           # update existing value
=            # function
"            # string
`            # string with variables evaluation
#            # comment
\            # escape for \r \n \t \\ \" \a \b \f \v
()           # function call or grouping
[]           # array
```

Binary operators order
```
* /              # number (high)
+ -              # number (low)
> >= < <=  == != # comparision (high)
|| &&            # comparision (low)
:=               # update existing variable
<-               # effect
```

Buildin
# any
- string: string
# int
# string
- slice: int int string
- sub: string string string
- int: opt(int)
- trim: string
# bool
- if a: a a a
- then a: opt(a)
# array a
- size: int
- first: opt(a)
- slice: int int string
- map b: (a b) array(a)
- keep: (a bool) array(a)
# opt a
- or: opt(a) opt(a)
- and b: opt(b)
- then b: (a b) opt(b)
- catch b: (error b) b
- ignore b: b
# try a
- then b: (a b) try(b)
- and b: try(b)
- ignore b: try(b)
